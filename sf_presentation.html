<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>CRS with sf</title>
    <meta charset="utf-8" />
    <meta name="author" content="Lisa Pramann &amp; Caitlin Sarro" />
    <meta name="date" content="2021-10-25" />
    <script src="sf_presentation_files/header-attrs/header-attrs.js"></script>
    <link href="sf_presentation_files/remark-css/default.css" rel="stylesheet" />
    <link href="sf_presentation_files/remark-css/metropolis.css" rel="stylesheet" />
    <link href="sf_presentation_files/remark-css/metropolis-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# CRS with sf
### Lisa Pramann &amp; Caitlin Sarro
### Hertie School
### 2021-10-25

---

class: inverse, center, middle
name: welcome

&lt;style type="text/css"&gt;
@media print { # print out incremental slides; see https://stackoverflow.com/questions/56373198/get-xaringan-incremental-animations-to-print-to-pdf/56374619#56374619
  .has-continuation {
    display: block !important;
  }
}
&lt;/style&gt;


```r
# figures formatting setup
options(htmltools.dir.version = FALSE)
library(knitr)
opts_chunk$set(
  prompt = T,
  fig.align="center", #fig.width=6, fig.height=4.5, 
  # out.width="748px", #out.length="520.75px",
  dpi=300, #fig.path='Figs/',
  cache=T, #echo=F, warning=F, message=F
  engine.opts = list(bash = "-l")
  )
## Next hook based on this SO answer: https://stackoverflow.com/a/39025054
knit_hooks$set(
  prompt = function(before, options, envir) {
    options(
      prompt = if (options$engine %in% c('sh','bash')) '$ ' else 'R&gt; ',
      continue = if (options$engine %in% c('sh','bash')) '$ ' else '+ '
      )
})
```

 


---

#Agenda 

###1. Modeling the world 
###2. What are CRS?
###3. CRS and Datums
###4. CRS in R
###
###
###7. Spatial Data Operations

---
#Modelling the World
##How does the Earth really look like? 
Refreshing you knowledge from your Geo-course during high school/undergrad-studies...

.pull-left-small2[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="http://www.geo.hunter.cuny.edu/~jochen/gtech201/lectures/lec6concepts/Datums/Basics%20of%20datums_files/image001.gif" width=600&gt;
&lt;/div&gt;
]

---
#What is a “Coordinate Reference System” (CRS) ?
##(Geographic Coordination System or Spatial Reference System) 

- Used to model the World 
- Set locations 
- Utilize 
- latitude (horizontal) 
- longitude (vertical)
- basis for planar coordinates and GIS (Geoinformation Systems)

.pull-left-small2[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="./15-LisaPramann-CSR-with-sf/sf_presentation_files/figure-html/planar_corrdinates.jpg" width=300&gt;
&lt;img src="./15-LisaPramann-CSR-with-sf/sf_presentation_files/figure-html/long_lat.jpg" width=300&gt;
&lt;/div&gt;
]

ADD Reference to graphics 


---
#CRS and Datums

###As you have seen the Ellipsoid cannot model the earth (not even the Geoid) completely 

Therefore, different CCoordinate Reference Systems exist:

- *World Geodetic System* (WGS84, EPSG:4326)
approximates the whole earth; standard model

- *North American Datum* (NAD83, EPSG:6269)
- *Australian Geodetic Datum* (AGD84, EPSG:420)

.pull-left-small2[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="~/15-LisaPramann-CSR-with-sf/sf_presentation_files/figure-html/eellipsoid.jpg" width=600&gt;
&lt;/div&gt;
]

Datums can usually be converted to one another.

---

# EXAMPLE What is a “Coordinate Reference System” (CRS) ?

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#EB811B' size=1px style="width:1000px; margin:auto;"/&gt;&lt;/html&gt;
&lt;br&gt;
CRS defines how the spatial elements of the data relate to the surface of the Earth (or other bodies). CRSs are either geographic or projected, as introduced at the beginning of this chapter (see Figure 2.1). 

.pull-left-small2[
&lt;div align="center"&gt;
&lt;br&gt;
&lt;img src="https://i.pinimg.com/474x/77/db/8c/77db8c3bd9a6aef7447cebc65ea9fcb9.jpg" width=500&gt;
&lt;img src="https://geocompr.robinlovelace.net/figures/vector_lonlat.png" width=300&gt;
&lt;img src="https://geocompr.robinlovelace.net/figures/vector_projected.png" width=300&gt;

&lt;/div&gt;
]
FIGURE 2.1: Illustration of vector (point) data in which location of London (the red X) is represented with reference to an origin (the blue circle). The left plot represents a geographic CRS with an origin at 0° longitude and latitude. The right plot represents a projected CRS with an origin located in the sea west of the South West Peninsula.

---

# EXAMPLE Introduction to sf package
## Choosing a Projection

- Geographic coordinate systems identify any location on the Earth’s surface using two values — longitude and latitude Longitude is location in the East-West direction in angular distance from the Prime Meridian plane. Latitude is angular distance North or South of the equatorial plane. Distances in geographic CRSs are therefore not measured in meters. 
- Bullet 2
- Bullet 3

---

# CRS in R
##Introduction to sf package
## Example
Let’s look at how CRSs are stored in R spatial objects and how they can be set. For this, we need to read-in a vector dataset:


```r
R&gt; vector_filepath = system.file("shapes/world.gpkg", package = "spData")
R&gt; new_vector = read_sf(vector_filepath)
```

The crs() function can be used to access CRS information from a SpatRaster object17:



---

# Retrieve coordinate reference system from object
##

---

# Three Key Features
## 2 | Add CRS to a Shapefile
- so you can layer point data onto geometry and create complex maps

---

# Three Key Features
## 3 | Transform or convert coordinates of simple feature


```r
R&gt; p1 = st_point(c(7,52))
R&gt; p2 = st_point(c(-30,20))
R&gt; sfc = st_sfc(p1, p2, crs = 4326)
R&gt; sfc
```

```
## Geometry set for 2 features 
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -30 ymin: 20 xmax: 7 ymax: 52
## Geodetic CRS:  WGS 84
```

```
## POINT (7 52)
```

```
## POINT (-30 20)
```

```r
R&gt; #&gt; Geometry set for 2 features 
R&gt; #&gt; Geometry type: POINT
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -30 ymin: 20 xmax: 7 ymax: 52
R&gt; #&gt; Geodetic CRS:  WGS 84#&gt; POINT (7 52)#&gt; POINT (-30 20)st_transform(sfc, 3857)
R&gt; #&gt; Geometry set for 2 features 
R&gt; #&gt; Geometry type: POINT
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -3339585 ymin: 2273031 xmax: 779236.4 ymax: 6800125
R&gt; #&gt; Projected CRS: WGS 84 / Pseudo-Mercator#&gt; POINT (779236.4 6800125)#&gt; POINT (-3339585 2273031)st_transform(st_sf(a=2:1, geom=sfc), "+init=epsg:3857")
R&gt; #&gt; Warning: GDAL Message 1: +init=epsg:XXXX syntax is deprecated. It might return a CRS with a non-EPSG compliant axis order.#&gt; Simple feature collection with 2 features and 1 field
R&gt; #&gt; Geometry type: POINT
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -3339585 ymin: 2273031 xmax: 779236.4 ymax: 6800125
R&gt; #&gt; Projected CRS: WGS 84 / Pseudo-Mercator
R&gt; #&gt;   a                     geom
R&gt; #&gt; 1 2 POINT (779236.4 6800125)
R&gt; #&gt; 2 1 POINT (-3339585 2273031)try(st_transform(sfc, 3857, aoi = c(-280,-90,180,90)))
R&gt; #&gt; Warning: GDAL Error 1: Invalid dfWestLongitudeDeg#&gt; Error in CPL_transform(x, crs, aoi, pipeline, reverse, desired_accuracy,  : 
R&gt; #&gt;   values for area of interest not accepted
R&gt; 
R&gt; if (sf_extSoftVersion()["GDAL"] &gt;= "3.0.0") 
+   { st_transform(sfc, pipeline =
+     "+proj=pipeline +step +proj=axisswap +order=2,1") # reverse axes
+   st_transform(sfc, pipeline =
+     "+proj=pipeline +step +proj=axisswap +order=2,1", reverse = TRUE) } # also reverse axes
```

```
## Geometry set for 2 features 
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -30 ymin: 20 xmax: 7 ymax: 52
## CRS:           NA
```

```
## POINT (7 52)
## POINT (-30 20)
```

```r
R&gt; #&gt; Geometry set for 2 features 
R&gt; #&gt; Geometry type: POINT
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -30 ymin: 20 xmax: 7 ymax: 52
R&gt; #&gt; CRS:           NA#&gt; POINT (7 52)#&gt; POINT (-30 20)nc = st_read(system.file("shape/nc.shp", package="sf"))
R&gt; #&gt; Reading layer `nc' from data source 
R&gt; #&gt;   `/private/var/folders/24/8k48jl6d249_n_qfxwsl6xvm0000gn/T/RtmpOavmau/temp_libpath94fd3649a05d/sf/shape/nc.shp' 
R&gt; #&gt;   using driver `ESRI Shapefile'
R&gt; #&gt; Simple feature collection with 100 features and 14 fields
R&gt; #&gt; Geometry type: MULTIPOLYGON
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
R&gt; #&gt; Geodetic CRS:  NAD27st_area(nc[1,]) # area from long/lat
R&gt; #&gt; 1137107793 [m^2]st_area(st_transform(nc[1,], 32119)) # NC state plane, m
R&gt; #&gt; 1137590142 [m^2]st_area(st_transform(nc[1,], 2264)) # NC state plane, US foot
R&gt; #&gt; 12244869403 [US_survey_foot^2]library(units)
R&gt; #&gt; udunits database from /Users/runner/work/_temp/Library/units/share/udunits/udunits2.xmlset_units(st_area(st_transform(nc[1,], 2264)), m^2)
R&gt; #&gt; 1137590142 [m^2]st_transform(structure(p1, proj4string = "+init=epsg:4326"), "+init=epsg:3857")
R&gt; #&gt; POINT (779236.4 6800125)st_wrap_dateline(st_sfc(st_linestring(rbind(c(-179,0),c(179,0))), crs = 4326))
R&gt; #&gt; Geometry set for 1 feature 
R&gt; #&gt; Geometry type: MULTILINESTRING
R&gt; #&gt; Dimension:     XY
R&gt; #&gt; Bounding box:  xmin: -180 ymin: 0 xmax: 180 ymax: 0
R&gt; #&gt; Geodetic CRS:  WGS 84#&gt; MULTILINESTRING ((-179 0, -180 0), (180 0, 179 0))library(maps)
R&gt; wrld &lt;- st_as_sf(maps::map("world", fill = TRUE, plot = FALSE))
R&gt; wrld_wrap &lt;- st_wrap_dateline(wrld, options = c("WRAPDATELINE=YES", "DATELINEOFFSET=180"),
+    quiet = TRUE)
```

```
## Warning in CPL_wrap_dateline(st_geometry(x), options, quiet): GDAL Error 1:
## IllegalArgumentException: Points of LinearRing do not form a closed linestring

## Warning in CPL_wrap_dateline(st_geometry(x), options, quiet): GDAL Error 1:
## IllegalArgumentException: Points of LinearRing do not form a closed linestring
```

```r
R&gt; #&gt; Warning: GDAL Error 1: IllegalArgumentException: Points of LinearRing do not form a closed linestring#&gt; Warning: GDAL Error 1: IllegalArgumentException: Points of LinearRing do not form a closed linestring
R&gt; 
R&gt; wrld_moll &lt;- st_transform(wrld_wrap, "+proj=moll")
R&gt; plot(st_geometry(wrld_moll), col = "transparent")
```

&lt;img src="sf_presentation_files/figure-html/unnamed-chunk-5-1.png" style="display: block; margin: auto;" /&gt;

```r
R&gt; sf_proj_info("datum")
```

```
## Dataframe mit 0 Spalten und 0 Zeilen
```

```r
R&gt; #&gt; data frame with 0 columns and 0 rows
```

---
# How to work with Spatial Data (1)
##Some simple spatial data operations

1) Geometric measurements
CRSs include information about spatial units, however it is generally difficult to work with units to do geometric calculations (see difference of latitude and longitude data and planar coordinate systems) -&gt; the recent version of sf utilizes the units package which output is by default provided in m^2 

Lets see how that looks like for Belgium. We use the world data from the spData package:


```r
R&gt; Belgium = world[world$name_long == "Belgium", ]
R&gt; st_area(Belgium) 
```

```
## 30019548314 [m^2]
```

The number appears really big, better to set the units to km^2: 


```r
R&gt; units::set_units(st_area(Belgium), km^2)
```

```
## 30019.55 [km^2]
```

---
# How to work with Spatial Data (2)
##Some simple spatial data operations

2) Geometric measurements
sf can also measure distances between two points based on geometric data.

The package spData contains geometric data on London's districts lnd (FORMATE THIS WITH GREY BACKGROUND) and a dataset of cycle hire points in London cycle_hire FORMATE THIS WITH GREY BACKGROUND). 

We want to measure the distance from the cycle hire point at the Palace Gate to the centre of Redbridge. 


```r
R&gt; cycle_station_palace = cycle_hire %&gt;% filter(name == "Palace Gate")
R&gt; redbridge = lnd %&gt;% filter(NAME == "Redbridge")
R&gt; redbridge_centroid = st_centroid(redbridge) #gives you central point in selected area
```

```
## Warning in st_centroid.sf(redbridge): st_centroid assumes attributes are
## constant over geometries of x
```

```r
R&gt; st_distance(cycle_station_palace, redbridge_centroid)
```

```
## Units: [m]
##         [,1]
## [1,] 20258.6
```
The default of st_distance() is in m. We could can /1000 to get km. 

---
# How to work with Spatial Data (3)
##Making maps with plot()

LISA ADDS INFOS HERE 


## Slide with R Output


```r
R&gt; summary(cars)
```

```
##      speed           dist       
##  Min.   : 4.0   Min.   :  2.00  
##  1st Qu.:12.0   1st Qu.: 26.00  
##  Median :15.0   Median : 36.00  
##  Mean   :15.4   Mean   : 42.98  
##  3rd Qu.:19.0   3rd Qu.: 56.00  
##  Max.   :25.0   Max.   :120.00
```

## Print the Slides


```r
R&gt; #text has to go back
```


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9",
"hash": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
